<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Confirm Investment</title>

<style>
:root{
  --bg:#083a34;
  --card:#10c7a7;
  --card2:#0b5f56;
  --accent:#22ff9a;
  --text:#ffffff;
  --muted:#d6f1ec;
}

*{box-sizing:border-box;font-family:system-ui,sans-serif}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

header{ padding:20px }

.card{
  margin:16px;
  background:linear-gradient(135deg,var(--card),var(--card2));
  border-radius:18px;
  padding:20px;
}

.row{
  display:flex;
  justify-content:space-between;
  margin:10px 0;
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  margin-top:10px;
  font-size:16px;
}

.summary{
  margin-top:14px;
  font-size:14px;
}

button{
  width:100%;
  padding:16px;
  border-radius:30px;
  border:none;
  margin-top:18px;
  font-weight:600;
  font-size:16px;
  background:linear-gradient(90deg,var(--accent),#00d4ff);
  color:#00352f;
  cursor:pointer;
}

.note{
  margin-top:14px;
  font-size:12px;
  opacity:.9;
}
</style>
</head>

<body>

<header>
  <h2>Confirm Investment</h2>
</header>

<div class="card">
  <h3 id="planName">â€”</h3>

  <div class="row">
    <span>Duration</span>
    <strong id="planDuration">â€”</strong>
  </div>

  <label>Amount to invest (ZMW)</label>
  <input id="amount" type="number" placeholder="Enter amount" />

  <div class="summary" id="summary">
    Enter amount to see payout
  </div>

  <button id="confirmBtn">Confirm Investment</button>

  <div class="note">
    â€¢ Funds are locked until maturity<br>
    â€¢ Earnings go to Earnings Wallet
  </div>
</div>

<!-- âœ… THIS MUST BE type="module" -->
<script type="module">
/* ================= IMPORT YOUR EXISTING FILE ================= */
import { auth, createInvestment } from "./js/firebase.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

/* ================= DEBUG CONFIRM ================= */
console.log("âœ… confirm-investment.js loaded");

/* ================= LOAD PLAN ================= */
const plan = JSON.parse(localStorage.getItem("selectedPlan"));
if (!plan) {
  alert("No plan selected");
  location.href = "investments.html";
}

document.getElementById("planName").innerText = plan.name;
document.getElementById("planDuration").innerText = plan.days + " days";

const amountEl = document.getElementById("amount");
const summaryEl = document.getElementById("summary");
const btn = document.getElementById("confirmBtn");

/* ================= LIVE CALCULATOR ================= */
amountEl.addEventListener("input", () => {
  const amount = Number(amountEl.value);
  if (!amount) {
    summaryEl.innerText = "Enter amount to see payout";
    return;
  }

  const profit = amount * plan.percent / 100;
  summaryEl.innerHTML = `
    You invest <b>ZMW ${amount}</b><br>
    You receive <b>ZMW ${amount + profit}</b><br>
    Profit: ZMW ${profit}
  `;
});

/* ================= BUTTON CLICK ================= */
btn.addEventListener("click", () => {
  console.log("ðŸ”¥ Confirm button clicked");

  const amount = Number(amountEl.value);
  if (!amount || amount <= 0) {
    alert("Enter a valid amount");
    return;
  }

  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert("Please log in");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Processing...";

    try {
      await createInvestment(user.uid, plan, amount);
      alert("Investment successful");
      localStorage.removeItem("selectedPlan");
      location.href = "dashboard.html";
    } catch (e) {
      alert(e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Confirm Investment";
    }
  });
});
</script>

</body>
</html>
