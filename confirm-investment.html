<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Confirm Investment</title>

<style>
/* ... your existing styles ... */
</style>
</head>

<body>

<div class="card">
  <h2 id="planName">Loading plan‚Ä¶</h2>
  <p id="planDuration"></p>

  <input id="amount" type="number" placeholder="Enter amount" />

  <div id="summary" style="margin-top:10px;font-size:14px;">
    ‚Äî
  </div>

  <button id="confirmBtn">Confirm Investment</button>
</div>

<script type="module">
// Debug immediately
console.log("‚úÖ confirm-investment.html JS loaded");

/* ===============================
   IMPORT FIREBASE - CONSISTENT VERSION
================================ */
import { auth, createInvestment } from "./js/firebase.js";
import { onAuthStateChanged } from 
  "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

console.log("‚úÖ firebase.js imported");

/* ===============================
   ELEMENTS
================================ */
const planNameEl = document.getElementById("planName");
const planDurationEl = document.getElementById("planDuration");
const amountEl = document.getElementById("amount");
const summaryEl = document.getElementById("summary");
const btn = document.getElementById("confirmBtn");

/* ===============================
   LOAD PLAN
================================ */
const plan = JSON.parse(localStorage.getItem("selectedPlan"));

if (!plan) {
  alert("‚ùå No plan found");
  window.location.href = "investments.html";
} else {
  console.log("‚úÖ Plan loaded:", plan);
}

planNameEl.textContent = plan.name;
planDurationEl.textContent = `${plan.days} days`;

/* ===============================
   AUTH STATE
================================ */
let currentUser = null;
let isAuthReady = false;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    isAuthReady = true;
    console.log("‚úÖ User authenticated:", user.uid);
  } else {
    alert("‚ùå Not logged in");
    window.location.href = "login.html";
  }
});

/* ===============================
   CALCULATOR
================================ */
amountEl.addEventListener("input", () => {
  const amount = Number(amountEl.value);
  if (!amount || amount <= 0) {
    summaryEl.textContent = "‚Äî";
    return;
  }
  const profit = amount * plan.percent / 100;
  summaryEl.innerHTML =
    `You invest ZMW ${amount.toFixed(2)}<br>
     Profit ZMW ${profit.toFixed(2)}<br>
     Total ZMW ${(amount + profit).toFixed(2)}`;
});

/* ===============================
   BUTTON CLICK HANDLER (IMPROVED)
================================ */
btn.addEventListener("click", async () => {
  console.log("üü¢ BUTTON CLICKED - Starting investment process");
  
  // Validate auth
  if (!isAuthReady) {
    alert("‚ö†Ô∏è Authentication still loading. Please wait...");
    return;
  }
  
  if (!currentUser) {
    alert("‚ùå Please log in first");
    window.location.href = "login.html";
    return;
  }
  
  // Validate amount
  const amount = Number(amountEl.value);
  if (!amount || amount <= 0) {
    alert("‚ùå Please enter a valid amount greater than 0");
    amountEl.focus();
    return;
  }
  
  // Validate plan
  if (!plan || !plan.name || !plan.percent || !plan.days) {
    alert("‚ùå Invalid plan selected");
    window.location.href = "investments.html";
    return;
  }
  
  // Show confirmation
  const confirmInvest = confirm(
    `Confirm investment?\n\n` +
    `Plan: ${plan.name}\n` +
    `Amount: ZMW ${amount.toFixed(2)}\n` +
    `Duration: ${plan.days} days\n` +
    `Expected Profit: ZMW ${(amount * plan.percent / 100).toFixed(2)}`
  );
  
  if (!confirmInvest) return;
  
  // Disable button and show loading
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Processing‚Ä¶";
  btn.style.opacity = "0.7";
  
  try {
    console.log("‚û°Ô∏è Calling createInvestment() with:", {
      uid: currentUser.uid,
      plan,
      amount
    });
    
    const result = await createInvestment(currentUser.uid, plan, amount);
    console.log("‚úÖ Investment successful:", result);
    
    alert("üéâ Investment Successful!\nYour funds have been locked for the selected period.");
    
    // Cleanup and redirect
    localStorage.removeItem("selectedPlan");
    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 500);
    
  } catch (error) {
    console.error("‚ùå Investment error:", error);
    alert(`Investment Failed:\n${error.message}`);
    
    // Re-enable button
    btn.disabled = false;
    btn.textContent = originalText;
    btn.style.opacity = "1";
  }
});

/* ===============================
   ADDITIONAL DEBUGGING
================================ */
// Check if button exists and can be clicked
console.log("Button element found:", !!btn);
console.log("Plan loaded:", plan);

// Add Enter key support for amount field
amountEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    btn.click();
  }
});
</script>

</body>
</html>