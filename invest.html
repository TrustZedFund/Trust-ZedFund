<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Invest</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body { font-family:system-ui; margin:0; background:#f4f7f7; }
header { background:#083a34; color:#fff; padding:20px; }
.plan {
  background:linear-gradient(135deg,#0f8f6a,#083a34);
  margin:16px;
  padding:20px;
  border-radius:18px;
  color:#fff;
}
input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
}
button {
  width:100%;
  margin-top:14px;
  padding:14px;
  border-radius:30px;
  border:none;
  font-weight:600;
  background:#22ff9a;
  color:#00352f;
}
</style>
</head>

<body>

<header>
  <h2>Investment Plans</h2>
</header>

<div class="plan">
  <h3>Starter Plan</h3>
  <p>Minimum: ZMK 500</p>

  <input id="amount" type="number" min="500" placeholder="Enter amount">

  <button id="investBtn">Invest</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, get, update, push, set } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDvkMDvK5d7P7p2zatUjIsJNGhBf18yeTQ",
  authDomain: "trust-zedfund.firebaseapp.com",
  databaseURL: "https://trust-zedfund-default-rtdb.firebaseio.com",
  projectId: "trust-zedfund",
  storageBucket: "trust-zedfund.firebasestorage.app",
  messagingSenderId: "129257684900",
  appId: "1:129257684900:web:95e94293366a26f9448b31"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user;

/* AUTH */
onAuthStateChanged(auth, u => {
  if (!u) location.href = "login.html";
  user = u;
});

/* INVEST BUTTON â€” THIS ALWAYS WORKS */
document.getElementById("investBtn").addEventListener("click", async () => {

  const amount = Number(document.getElementById("amount").value);
  if (!amount || amount < 500) {
    alert("Minimum investment is ZMK 500");
    return;
  }

  /* GET BALANCE */
  const balRef = ref(db, `users/${user.uid}/balances/deposit`);
  const balSnap = await get(balRef);
  const balance = balSnap.exists() ? Number(balSnap.val()) : 0;

  if (balance < amount) {
    alert("Insufficient funds. Please deposit.");
    location.href = "deposit.html";
    return;
  }

  /* CALCULATE */
  const days = 30;
  const dailyRate = 10;
  const dailyProfit = (amount / 500) * dailyRate;
  const totalProfit = dailyProfit * days;

  /* DEDUCT */
  await update(ref(db, `users/${user.uid}/balances`), {
    deposit: balance - amount
  });

  /* SAVE INVESTMENT */
  await set(push(ref(db, `users/${user.uid}/investments`)), {
    plan: "Starter Plan",
    amount,
    dailyProfit,
    totalProfit,
    days,
    startTime: Date.now(),
    maturityTime: Date.now() + days * 86400000,
    status: "active"
  });

  /* TRANSACTION */
  await set(push(ref(db, `users/${user.uid}/transactions`)), {
    type: "Investment",
    amount,
    date: new Date().toISOString()
  });

  alert("Investment successful!");
  location.href = "dashboard.html";
});
</script>

</body>
</html>
